<include file="Public:editor" />
<div class="datagrid-toolbar form-panel">
    <table>
        <tr>
            <td width="100%">
                <a class="easyui-linkbutton" iconCls="icon-save" plain="true" onclick="onSubmit()">保存</a>
            </td>
        </tr>
    </table>
</div>
<form data-url="{:U('save')}" method="post" class="content-layout">
    <div class="easyui-panel" title="题目表单" style="padding:10px;">
        <table class="form-panel">
            <tr>
                <th>广告标题：</th>
                <td>
                    <input name="ad_title" class="easyui-textbox" value="{$info.ad_title}" size="45" data-options="required:true">
                </td>
            </tr>
            <tr>
                <th>广告图：</th>
                <td id="ad_upload">
                    <volist name="info.ad_config" id="vo">
                        <div class="ad_upload">
                            <input class="easyui-textbox" name="ad_config[]" data-options="prompt:'图片路径...',buttonText:'选择图片', width:'350px', onClickButton: function(){onUpload(this);}" value="{$vo}">
                            <a class="easyui-linkbutton" onclick="removeImg(this)">-</a>
                        </div>
                    </volist>
                    <div class="ad_upload">
                        <input class="easyui-textbox" name="ad_config[]" data-options="prompt:'图片路径...',buttonText:'选择图片', width:'350px', onClickButton: function(){onUpload(this);}" value="{$info.thumb_img}">
                        <a class="easyui-linkbutton" onclick="addImg(this)">+</a>
                    </div>
                </td>
            </tr>
            <tr>
                <th>颜色：</th>
                <td class="attrBox" attr_id="1">
                    <input type="checkbox" name="attr_v_id" value="1" title="红色">红色
                    <input type="checkbox" name="attr_v_id" value="2" title="蓝色">蓝色
                </td>
            </tr>
            <tr>
                <th>颜色3：</th>
                <td class="attrBox" attr_id="2">
                    <input type="checkbox" name="attr_v_id" value="4" title="红色">红色
                    <input type="checkbox" name="attr_v_id" value="5" title="蓝色">蓝色
                </td>
            </tr>
        </table>
        <table id="attr_box">

        </table>
        <div class="panel-footer" style="padding:5px;">
            <textarea id="content" style="display: none;"></textarea>
            <input type="hidden" name="ad_id" value="{$info.ad_id}">
            <a class="easyui-linkbutton button-large" iconCls="icon-save" onclick="onSubmit()"> 保存</a>
        </div>
    </div>

</form>
<script type="text/javascript">
    var ue;
    $(function(){
        $('.attrBox').each(function(index){

            var attrChecked = $('[name="attr_v_id"]:checked');
            //处理属性数组
            var attr = [];
            for(var i = 0; i < attrChecked.length; i ++) {
                var attr_id = attrChecked.eq(i).attr('attr_id');
                attr.push({'attr_id': attr_id})

            }
            alert(JsonFormat.stringify(attr));
        });
        ue = UE.getEditor('content',{
            hide:true,
            onready: function(){
                this.hide();
            }
        });
    });

    function addImg(obj) {
        var self = $(obj);
        var elem = self.parents('.ad_upload');
        var newDiv = $('<div></div>');
        newDiv.addClass('ad_upload');
        var newInput = $('<input>');
        newInput.attr({
            'name': 'ad_config[]'
        })
        newInput.appendTo(newDiv);
        newInput.textbox({
            prompt: '图片路径...',
            buttonText: '选择图片',
            width: '350px',
            onClickButton: function() {
                onUpload(this);
            }
        });
        
        var newA = $('<a></a>');
        newA.appendTo(newDiv);
        newA.linkbutton({
            text:'-',
            onClick: function() {
                removeImg(this);
            }
        })
        newDiv.insertBefore(elem);
    }

    function removeImg(obj) {
        var self = $(obj);
        var elem = self.parents('.ad_upload');
        elem.remove();
    }

    function onUpload(obj) {
        var upload = $(obj);
        var readyHandler = function(t, args){
            upload.textbox('setValue', args[0].src);
            delete upload;
            ue.removeListener('afterinsertimage', readyHandler);
        };
        ue.addListener('afterinsertimage', readyHandler);

        var dlg = ue.getDialog("insertimage");
        dlg.render();
        dlg.open();

    }

    function onSubmit(){
        easyui.submit('.content-layout', function(result){
            try{
                easyui.confirm(result.info + '是否关闭窗口？', function(isOk){
                    if(isOk) {
                        parent.closeTab();
                        return;
                    }
                });
            }catch (e){}
        })
    }
    initUploadImage('#thumb_img');
</script>